<app-header></app-header>

<div class="checkout-container" *ngIf="cart.length">
    <h2>สรุปการสั่งซื้อ</h2>

    <table class="cart-table">
        <thead>
            <tr>
                <th>รูป</th>
                <th>เกม</th>
                <th>ราคา/ชิ้น</th>
                <th>จำนวน</th>
                <th>รวม</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let item of cart">
                <td><img [src]="item.image_url" alt="{{ item.name }}" width="60"></td>
                <td>{{ item.name }}</td>
                <td>{{ item.price | number:'1.2-2' }} บาท</td>
                <td>{{ item.quantity }}</td>
                <td>{{ (item.price * item.quantity) | number:'1.2-2' }} บาท</td>
            </tr>
        </tbody>
    </table>

    <!-- ส่วนลด -->
    <div class="discount-section">
        <div class="input-group">
            <input 
                type="text" 
                placeholder="ใส่โค้ดส่วนลด" 
                [(ngModel)]="discountCodeInput"
                [class.error]="hasDiscountError()"
                (keyup.enter)="applyDiscount()"
            >
            <button 
                (click)="applyDiscount()" 
                [disabled]="isLoading || !discountCodeInput.trim()"
            >
                {{ isLoading ? 'กำลังตรวจสอบ...' : 'ใช้โค้ด' }}
            </button>
        </div>

        <!-- แสดง error -->
        <div 
            *ngIf="hasDiscountError()" 
            class="discount-message error {{ getDiscountErrorClass() }}"
        >
            {{ discountError }}
        </div>

        <!-- แสดงส่วนลดที่ใช้งานได้ -->
        <div 
            *ngIf="hasDiscount() && !hasDiscountError()" 
            class="discount-message success"
        >
            ใช้โค้ด "{{ discount?.code }}" สำเร็จ! {{ getDiscountText() }}
            <button (click)="removeDiscount()" class="btn-remove">✕</button>
        </div>
    </div>

    <!-- ยอดรวม -->
    <div class="total-section">
        <p>
            <span>ยอดรวม:</span>
            <span>{{ total | number:'1.2-2' }} บาท</span>
        </p>
        
        <p *ngIf="hasDiscount() && !hasDiscountError()">
            <span>ส่วนลด:</span>
            <span class="discount-amount">- {{ getDiscountAmount() | number:'1.2-2' }} บาท</span>
        </p>
        
        <p class="final">
            <span>ยอดชำระ:</span>
            <span>{{ finalAmount | number:'1.2-2' }} บาท</span>
        </p>
    </div>

    <button 
        mat-raised-button 
        color="accent" 
        (click)="placeOrder()"
        [disabled]="isLoading"
    >
        {{ isLoading ? 'กำลังดำเนินการ...' : 'ยืนยันการซื้อ' }}
    </button>
</div>

<div *ngIf="!cart.length" class="empty-cart">
    ตะกร้าว่าง
</div>