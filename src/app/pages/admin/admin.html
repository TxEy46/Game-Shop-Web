<!-- ================= Header ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ Admin ================= -->
<app-header-admin></app-header-admin>

<!-- ================= ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Page Header) ================= -->
<div class="page-header">
    <!-- <h1 class="page-title">üéÆ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏°</h1> -->
    <div class="header-buttons">
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà -->
        <button mat-raised-button color="primary" (click)="openAddGame()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î -->
        <button mat-raised-button color="accent" (click)="openDiscountManager()">
            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
        </button>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° -->
        <button mat-raised-button color="warn" (click)="viewAllTransactions()">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</button>
    </div>
</div>

<!-- ================= ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏° (Game List) ================= -->
<div class="game-list">
    <div class="game-card" *ngFor="let game of games" (click)="openEditGame(game)">
        <img [src]="game.image_url || 'assets/placeholder.png'" alt="{{ game.name }}">
        <div class="overlay">
            <p class="game-name">{{ game.name }}</p>
            <p class="game-price">{{ game.price | currency:'THB':'symbol':'1.0-0' }}</p>
        </div>
    </div>
</div>

<!-- Edit/Add Game Dialog -->
<ng-template #editDialog let-data>
    <h2 mat-dialog-title>{{ data.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Å‡∏°' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà' }}</h2>
    <mat-dialog-content class="dialog-content">
        <div class="modal-image-upload" (click)="fileInput.click()">
            <ng-container *ngIf="previews.get(data.id || 0); else addIcon">
                <img [src]="previews.get(data.id || 0)" alt="Preview">
            </ng-container>
            <ng-template #addIcon>
                <span class="plus-icon">+</span>
            </ng-template>
            <input #fileInput type="file" (change)="onFileChange($event, data.id || 0)" hidden>
        </div>

        <div class="dialog-form">
            <mat-form-field appearance="outline" class="full-width">
                <mat-label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°</mat-label>
                <input matInput [(ngModel)]="data.name">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
                <mat-label>‡∏£‡∏≤‡∏Ñ‡∏≤</mat-label>
                <input matInput type="number" [(ngModel)]="data.price">
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
                <mat-label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</mat-label>
                <textarea matInput [(ngModel)]="data.description" rows="4"></textarea>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
                <mat-label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</mat-label>
                <mat-select [(ngModel)]="data.category_id">
                    <mat-option *ngFor="let c of categories" [value]="c.id">{{ c.name }}</mat-option>
                </mat-select>
            </mat-form-field>

            <!-- <mat-form-field appearance="outline" class="full-width">
                <mat-label>‡∏ß‡∏±‡∏ô‡∏ß‡∏≤‡∏á‡∏Ç‡∏≤‡∏¢</mat-label>
                <input matInput type="date" [(ngModel)]="data.release_date">
            </mat-form-field> -->
        </div>
    </mat-dialog-content>

    <mat-dialog-actions class="dialog-actions">
        <button mat-raised-button color="warn" *ngIf="data.id"
            (click)="deleteGame(data.id); dialogRef.close()">‡∏•‡∏ö</button>
        <div>
            <button mat-button mat-dialog-close>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button mat-raised-button color="primary" (click)="saveGame(data);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </mat-dialog-actions>
</ng-template>

<!-- ================= Dialog ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ================= -->
<ng-template #discountDialog let-data>
    <h2 mat-dialog-title>{{ data.id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà' }}</h2>
    <mat-dialog-content class="dialog-form">

        <!-- ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡πâ‡∏î -->
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡πâ‡∏î</mat-label>
            <input matInput [(ngModel)]="data.code">
        </mat-form-field>

        <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î -->
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</mat-label>
            <mat-select [(ngModel)]="data.type">
                <mat-option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏ô‡∏ï‡πå</mat-option>
                <mat-option value="fixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î -->
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</mat-label>
            <input matInput type="number" [(ngModel)]="data.value">
        </mat-form-field>

        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ -->
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ</mat-label>
            <input matInput type="number" [(ngModel)]="data.usage_limit">
        </mat-form-field>

        <!-- ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ -->
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</mat-label>
            <input matInput type="number" [(ngModel)]="data.min_total">
        </mat-form-field>

        <!-- ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ -->
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</mat-label>
            <input matInput type="date" [(ngModel)]="data.end_date">
        </mat-form-field>

        <!-- ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
        <mat-checkbox [(ngModel)]="data.single_use_per_user">‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</mat-checkbox>

        <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
        <mat-checkbox [(ngModel)]="data.active">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</mat-checkbox>
    </mat-dialog-content>

    <mat-dialog-actions>
        <button mat-button mat-dialog-close>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button mat-raised-button color="primary" (click)="saveDiscountCode(data)">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </mat-dialog-actions>
</ng-template>


<!-- ================= Dialog ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° ================= -->
<ng-template #transactionsDialog let-data>
    <h2 mat-dialog-title>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
    <mat-dialog-content class="scrollable-dialog">
        <table class="transactions-table mat-elevation-z4">
            <thead>
                <tr>
                    <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                    <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                    <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let t of transactions">
                    <td>{{ t.user_name || t.user_id }}</td>
                    <td>{{ t.type }}</td>
                    <td>{{ t.amount | currency:'THB':'symbol' }}</td>
                    <td>{{ t.description }}</td>
                    <td>{{ t.created_at | date:'short' }}</td>
                </tr>
            </tbody>
        </table>
    </mat-dialog-content>
    <mat-dialog-actions>
        <button mat-button mat-dialog-close>‡∏õ‡∏¥‡∏î</button>
    </mat-dialog-actions>
</ng-template>

<!-- ================= Dialog ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ï‡∏≤‡∏£‡∏≤‡∏á) ================= -->
<ng-template #discountManagerDialog>
    <h2 mat-dialog-title>üéüÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h2>
    <mat-dialog-content class="scrollable-dialog">
        <table mat-table [dataSource]="discountCodes" class="mat-elevation-z8 discount-table">

            <!-- ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡πâ‡∏î -->
            <ng-container matColumnDef="code">
                <th mat-header-cell *matHeaderCellDef>‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡πâ‡∏î</th>
                <td mat-cell *matCellDef="let d">{{ d.code }}</td>
            </ng-container>

            <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
            <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                <td mat-cell *matCellDef="let d">{{ d.type === 'percent' ? '‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏ô‡∏ï‡πå' : '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' }}</td>
            </ng-container>

            <!-- ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ -->
            <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th>
                <td mat-cell *matCellDef="let d">{{ d.value }}</td>
            </ng-container>

            <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ -->
            <ng-container matColumnDef="usage_limit">
                <th mat-header-cell *matHeaderCellDef>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ</th>
                <td mat-cell *matCellDef="let d">{{ d.usage_limit || '‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î' }}</td>
            </ng-container>

            <!-- ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
            <ng-container matColumnDef="single_use_per_user">
                <th mat-header-cell *matHeaderCellDef>‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</th>
                <td mat-cell *matCellDef="let d">{{ d.single_use_per_user ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà' }}</td>
            </ng-container>

            <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î -->
            <ng-container matColumnDef="active">
                <th mat-header-cell *matHeaderCellDef>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <td mat-cell *matCellDef="let d">{{ d.active ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' }}</td>
            </ng-container>

            <!-- Countdown -->
            <ng-container matColumnDef="countdown">
                <th mat-header-cell *matHeaderCellDef>Countdown</th>
                <td mat-cell *matCellDef="let d">{{ discountCountdowns[d.id] || '-' }}</td>
            </ng-container>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                <td mat-cell *matCellDef="let d">
                    <button mat-icon-button color="primary" (click)="openDiscountDialog(d)">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="deleteDiscountCode(d.id)">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </ng-container>

            <!-- Header ‡πÅ‡∏•‡∏∞ Row -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
    </mat-dialog-content>
    <mat-dialog-actions>
        <button mat-raised-button color="primary" (click)="openDiscountDialog()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà</button>
        <button mat-button mat-dialog-close>‡∏õ‡∏¥‡∏î</button>
    </mat-dialog-actions>
</ng-template>